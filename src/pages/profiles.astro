---
/**
 * /profiles - Profile Selection Page
 *
 * This page allows children to select their profile to start playing.
 * Parents can also manage profiles through the Parental Gate.
 *
 * Features:
 * - Display all child profiles (max 5)
 * - Add new profile (protected by Parental Gate)
 * - Profile selection redirects to /game/categories
 * - Smart redirect logic based on profile count
 *
 * User Story: US-002 (Select Child Profile)
 * Related: US-003 (Create Child Profile), US-007 (Profile Selection)
 */

import Layout from "@/layouts/Layout.astro";
import ProfileManager from "@/components/ProfileManager";
import AutoSelectProfile from "@/components/AutoSelectProfile";
import AppHeader from "@/components/AppHeader";

// Disable prerendering for this page (requires authentication)
export const prerender = false;

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/auth/login");
}

const supabase = Astro.locals.supabase;

// Fetch profiles for this user
const { data: profiles, error } = await supabase.from("profiles").select("*").eq("parent_id", user.id);

if (error) {
  console.error("Error fetching profiles:", error);
}

const profileCount = profiles?.length ?? 0;

// Check if user explicitly wants to switch profiles (from "Zmień profil" button)
const url = new URL(Astro.request.url);
const isSwitchingProfile = url.searchParams.get("switch") === "true";

// SMART REDIRECT LOGIC
// If 1 profile AND user didn't click "Zmień profil" → auto-select and redirect to game categories
// Store profile data to pass to AutoSelectProfile component
let singleProfile = null;
if (profileCount === 1 && profiles && !isSwitchingProfile) {
  const profile = profiles[0];

  // Set active profile cookie
  // Note: secure flag only works on HTTPS, use false for local development
  Astro.cookies.set("app_active_profile_id", profile.id, {
    path: "/",
    httpOnly: false, // Must be accessible from JS
    secure: import.meta.env.PROD, // Only secure in production
    sameSite: "lax",
    maxAge: 60 * 60 * 24 * 30, // 30 days
  });

  singleProfile = profile;
}

// If 0 or 2+ profiles OR user is switching → show profile management screen (continue rendering)
---

<Layout title="Wybierz Profil - Dopasuj Obrazek do Słowa">
  <!-- App Header with logout button -->
  <AppHeader client:load />

  <main class="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4 md:p-8">
    <div class="mx-auto max-w-6xl">
      {
        singleProfile ? (
          <AutoSelectProfile client:load profile={singleProfile} />
        ) : (
          <>
            <header class="mb-8 text-center">
              <h1 class="mb-2 text-4xl font-bold text-purple-800 md:text-5xl">Kto dziś gra?</h1>
              <p class="text-lg text-purple-600 md:text-xl">Wybierz swój profil, aby rozpocząć zabawę!</p>
            </header>

            <ProfileManager client:load />
          </>
        )
      }
    </div>
  </main>
</Layout>

<style>
  /* Additional page-specific styles if needed */
</style>
